stages:
  - install
  - build
  - auto_cd

cache:
  key: modules-cache
  paths:
    - node_modules/
    - dist

install:
  stage: install
  tags:
    - alex-front
  only:
    - tags
  script:
    - echo "开始install🔥🔥🔥"
    - pnpm install --no-frozen-lockfile
    - echo "完成install🔥🔥🔥"

build:
  stage: build
  script:
    - whoami
    - echo ------------
    - env
    - echo ------------
    - echo "开始代码打包💪💪💪"
    - pnpm run build
    - echo "完成代码打包💪💪💪"
    - tag_array_str=(${CI_BUILD_TAG//_/ })
    - tag_nu=${tag_array_str[1]}
    - docker login harbor-rongshu-saas.com -u rongshu -p Rs123456
    - docker build -t harbor-rongshu-saas.com/front/apsmanage_h5:0.${tag_nu} .
    - docker push harbor-rongshu-saas.com/front/apsmanage_h5:0.${tag_nu}
  tags:
    - alex-front
  only:
    - tags

#auto_cd:
#  stage: auto_cd
#  script:
#    - echo "auto_cd……"
#  tags:
#    - alex-front
#  only:
#    - tags

#auto_cd:
#  stage: auto_cd
#  variables:
#    JENKINS_URL: "http://jenkins.dianmi365.com"
#    JENKINS_JOB_VIEW_URL: "view/%E7%BB%A9%E6%95%88%E5%8F%91%E5%B1%95/job/%E7%BB%A9%E6%95%88%E5%8F%91%E5%B1%95%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E4%B8%AD%E5%8F%B0-dm.bp.performance/job/D_dm.bp.performance"
#  script:
#    - echo "Hi CD, AUTO DEPLOY!"
#    - http_code=`curl -o /dev/null -s -w %{http_code} -I -u cd:11f847d72f04e593deb22ac5a67e39a676 -X POST --url "${JENKINS_URL}/${JENKINS_JOB_VIEW_URL}/buildWithParameters?token=${CI_PROJECT_NAME}&RELEASE_VERSION_TAG=${CI_COMMIT_TAG}"`; if [ "u${http_code}" != "u201" ]; then exit 1; fi
#  rules:
#    - if: '$CI_COMMIT_TAG =~ /^dev.*$/'
#      when: on_success
#  tags:
#    - java-ci-runner
